name: Robust Real-time Rate Push

on:
  schedule:
    # æ¯ 15 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
    - cron: '*/15 * * * *'
  workflow_dispatch: 

jobs:
  push_rate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install requests
        run: pip install requests

      - name: Get Rate and Push
        env:
          BARK_KEY: ${{ secrets.BARK_KEY }}
          EX_KEY: ${{ secrets.EX_KEY }}
        run: |
          python - << 'EOF'
          import requests
          import os
          from datetime import datetime, timedelta
          from urllib.parse import quote

          def get_rate():
              api_key = os.environ.get('EX_KEY')
              url = f"https://v6.exchangerate-api.com/v6/{api_key}/latest/USD"
              try:
                  resp = requests.get(url, timeout=20)
                  data = resp.json()
                  if data.get('result') == 'success':
                      rates = data['conversion_rates']
                      usd_cny = rates.get('CNY')
                      eur_usd = rates.get('EUR')
                      eur_cny = usd_cny / eur_usd if eur_usd else 0
                      return round(usd_cny, 4), round(eur_cny, 4)
                  else:
                      print(f"API Error: {data.get('error-type')}")
              except Exception as e:
                  print(f"Request Failed: {e}")
              return None, None

          bark_key = os.environ.get('BARK_KEY')
          bj_time = (datetime.utcnow() + timedelta(hours=8)).strftime("%H:%M")

          usd, eur = get_rate()

          if usd and eur:
              title = f"å®æ—¶æ±‡ç‡æ›´æ–° [{bj_time}]"
              body = f"ğŸ‡ºğŸ‡¸ USD/CNY: {usd}\nğŸ‡ªğŸ‡º EUR/CNY: {eur}"
              print(f"æˆåŠŸè·å–: USD={usd}, EUR={eur}")
          else:
              title = "æ±‡ç‡æ›´æ–°å¼‚å¸¸"
              body = "æ— æ³•ä» API è·å–æ•°æ®ï¼Œè¯·æ£€æŸ¥ Secrets ä¸­çš„ EX_KEY"

          encoded_title = quote(title)
          encoded_body = quote(body)
          bark_url = f"https://api.day.app/{bark_key}?title={encoded_title}&body={encoded_body}&icon=https://api.iconify.design/flat-color-icons:currency-exchange.svg&group=Finance&autoCopy=1"
          
          try:
              requests.get(bark_url, timeout=10)
              print("Bark æ¨é€æŒ‡ä»¤å·²å‘é€")
          except Exception as e:
              print(f"Push Error: {e}")
          EOF
