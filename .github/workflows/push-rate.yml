name: Robust Real-time Rate Push

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch: 

jobs:
  push_rate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install requests
        run: pip install requests

      - name: Get Rate and Push
        env:
          BARK_KEY: ${{ secrets.BARK_KEY }}
          EX_KEY: ${{ secrets.EX_KEY }}
        run: |
          python - << 'EOF'
          import requests
          import os
          from datetime import datetime, timedelta
          from urllib.parse import quote

          def get_rate():
              key = os.environ.get('EX_KEY')
              # è¯¥æŽ¥å£ç›´æŽ¥è¿”å›ž USD ä¸ºåŸºå‡†çš„æ‰€æœ‰æ±‡çŽ‡
              url = f"https://v6.exchangerate-api.com/v6/{key}/latest/USD"
              try:
                  resp = requests.get(url, timeout=20)
                  data = resp.json()
                  if data.get('result') == 'success':
                      rates = data['conversion_rates']
                      usd_cny = rates.get('CNY')
                      eur_usd = rates.get('EUR')
                      # æ¢ç®— EUR/CNY
                      eur_cny = usd_cny / eur_usd if eur_usd else 0
                      return round(usd_cny, 4), round(eur_cny, 4)
              except Exception as e:
                  print(f"è¯·æ±‚å¤±è´¥: {e}")
              return None, None

          bark_key = os.environ.get('BARK_KEY')
          bj_time = (datetime.utcnow() + timedelta(hours=8)).strftime("%H:%M")

          usd, eur = get_rate()

          if usd and eur:
              title = f"å®žæ—¶æ±‡çŽ‡ [{bj_time}]"
              body = f"ðŸ‡ºðŸ‡¸ USD/CNY: {usd}\nðŸ‡ªðŸ‡º EUR/CNY: {eur}"
              # ç¨å¾®åŠ ä¸€ç‚¹éšæœºæ•°æˆ–æ—¶é—´æˆ³ï¼Œé˜²æ­¢ Bark æ¶ˆæ¯æŠ˜å 
          else:
              title = "æ±‡çŽ‡æ›´æ–°å¤±è´¥"
              body = "API æŽ¥å£å“åº”å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ Key æˆ–ç½‘ç»œ"

          encoded_title = quote(title)
          encoded_body = quote(body)
          
          # æ¢äº†ä¸€ä¸ªæ›´æ˜¾çœ¼çš„å›¾æ ‡
          bark_url = f"https://api.day.app/{bark_key}?title={encoded_title}&body={encoded_body}&icon=https://api.iconify.design/flat-color-icons:currency-exchange.svg&group=Rate&autoCopy=1"
          
          requests.get(bark_url)
          print(f"æŽ¨é€å®Œæˆ: {usd}")
          EOF
