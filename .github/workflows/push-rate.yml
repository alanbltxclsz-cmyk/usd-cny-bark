name: Every 15 & EUR to CNY Rate Push

on:
  schedule:
    # '*/15' è¡¨ç¤ºæ¯éš” 15 åˆ†é’Ÿè§¦å‘ä¸€æ¬¡ (0, 15, 30, 45åˆ†)
    - cron: '*/15 * * * *'
  workflow_dispatch: # ä¿ç•™æ‰‹åŠ¨æµ‹è¯•æŒ‰é’®

jobs:
  push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install requests
        run: pip install requests

      - name: Push USD & EUR to CNY Rate
        env:
          BARK_KEY: ${{ secrets.BARK_KEY }}
        run: |
          python - << 'EOF'
          import requests
          import os
          from urllib.parse import quote

          bark_key = os.environ.get('BARK_KEY')
          if not bark_key:
              print("é”™è¯¯: BARK_KEY æœªè®¾ç½®")
              exit(1)

          try:
              # è·å–æ±‡ç‡
              api_url = "https://open.er-api.com/v6/latest/USD"
              resp = requests.get(api_url, timeout=15)
              data = resp.json()

              if data.get('result') == 'success':
                  rates = data['rates']
                  usd_cny = round(rates.get('CNY', 0), 4)
                  eur_usd = rates.get('EUR', 0)
                  # äº¤å‰æ±‡ç‡è®¡ç®—
                  eur_cny = round(rates['CNY'] / eur_usd, 4) if eur_usd != 0 else 0
                  
                  title = "å®æ—¶æ±‡ç‡æ’­æŠ¥"
                  body = f"ğŸ‡ºğŸ‡¸ 1 USD = {usd_cny} CNY\nğŸ‡ªğŸ‡º 1 EUR = {eur_cny} CNY"
              else:
                  title = "æ±‡ç‡æ¥å£æé†’"
                  body = "æ•°æ®æºæ›´æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥"
          except Exception as e:
              title = "è„šæœ¬æ‰§è¡ŒæŠ¥é”™"
              body = f"é”™è¯¯è¯¦æƒ…: {str(e)[:50]}"

          # ç¼–ç å¤„ç†
          encoded_title = quote(title)
          encoded_body = quote(body)

          # æ„å»º Bark URL (å°† body æ”¾åœ¨å‚æ•°ä¸­æ›´ç¨³å®š)
          # åŠ ä¸Šäº†è‡ªåŠ¨å¤åˆ¶åŠŸèƒ½(autoCopy)å’Œåˆ†ç»„(group)
          bark_url = f"https://api.day.app/{bark_key}?title={encoded_title}&body={encoded_body}&sound=minuet&group=Finance&autoCopy=1"
          
          r = requests.get(bark_url)
          print(f"æ¨é€ç»“æœ: {r.status_code}, å†…å®¹: {body}")
          EOF
